<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coleta de Dados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10B981; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #059669; }
        .required-marker { color: #DC2626; font-weight: bold; margin-left: 2px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üìù</span>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Coleta de Dados <span class="text-emerald-600">eSocial Modelo 1</span></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-slate-500 hidden sm:block">
                        <span class="font-semibold text-emerald-600" id="totalRecordsDisplay">0</span> registros prontos
                    </div>
                    <button onclick="scrollToExport()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm">
                        Exportar Tabela
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="prose max-w-none">
                <h2 class="text-lg font-semibold text-slate-900 mb-2">Instru√ß√µes</h2>
                <p class="text-slate-600">Preencha os dados dos funcion√°rios. O sistema utilizar√° o modelo Excel configurado no servidor para gerar o arquivo final.</p>
                <div class="mt-4 p-3 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-sm text-slate-700 mb-2">LEGENDA</h3>
                    <ul class="text-sm space-y-1">
                        <li class="flex items-center"><span class="text-red-600 font-bold mr-2">üî¥</span> Obrigat√≥rio</li>
                        <li class="flex items-center"><span class="text-gray-500 font-bold mr-2">‚ö™</span> Opcional</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-lg border border-emerald-100 overflow-hidden">
            <div class="bg-slate-900 px-6 py-4 flex justify-between items-center">
                <h2 class="text-white text-lg font-semibold flex items-center"><span class="mr-2">üë§</span> Novo Funcion√°rio</h2>
                <button type="button" onclick="clearForm()" class="text-slate-300 hover:text-white text-sm underline">Limpar</button>
            </div>
            <div class="p-6">
                <form id="eSocialForm">
                    <div class="max-h-[700px] overflow-y-auto custom-scroll scroll-smooth p-2" id="formScrollArea">
                        <div id="dynamicFieldsContainer" class="space-y-8"></div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-slate-200 flex justify-end">
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center">
                            <span class="mr-2">üíæ</span> Salvar Registro
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" id="previewSection">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">Registros (<span id="countDisplay">0</span>)</h3>
                <button onclick="clearAllData()" class="text-red-500 hover:text-red-700 text-sm font-medium">Excluir Tudo</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">A√ß√µes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Matr√≠cula</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Cargo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">CPF</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Admiss√£o</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Nenhum registro.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="flex justify-center pb-12" id="exportSection">
            <button onclick="sendDataToBackend()" id="mainExportBtn" class="group relative inline-flex items-center justify-center p-0.5 mb-2 mr-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-emerald-600 to-green-500 opacity-50 cursor-not-allowed" disabled>
                <span class="relative px-8 py-3.5 transition-all ease-in duration-75 bg-white rounded-md group-hover:bg-opacity-0 text-lg font-bold">
                    üì• Gerar Excel no Servidor
                </span>
            </button>
        </section>

    </main>

    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <span id="toastMsg">Mensagem</span>
    </div>

    <script>
        const HEADERS_LIST = [
            "Cod.Unid", "Nome Unidade", "Cod.Setor", "Nome Setor", "Cod.Cargo", "Nome Cargo", 
            "Matr√≠cula", "Cod Funcion√°rio", "Nome Funcion√°rio", "Dt.Nascimento", "Sexo", "Situa√ß√£o", 
            "Dt.Admiss√£o", "Dt.Demiss√£o", "Estado Civil", "Pis/Pasep", "Contrata√ß√£o", "Rg", 
            "UF-RG", "CPF", "CTPS", "Endere√ßo", "Bairro", "Cidade", "UF", "Cep", "Tel", 
            "Naturalidade", "Cor", "E-mail", "Deficiencia", "CBO", "GFIP", "Endere√ßo Unidade", 
            "Bairro Unidade", "Cidade Unidade", "Estado Unidade", "Cep Unidade", "CNPJ Unidade", 
            "Inscri√ß√£o Unidade", "Tel1 Unidade", "Tel2 Unidade", "Tel3 Unidade", "Tel4 Unidade", 
            "Contato Unid", "Cnae", "N√∫mero Endere√ßo Funcion√°rio", "Complemento Endere√ßo Funcion√°rio", 
            "Raz√£o Social Unid.", "Nome da Mae do Funcion√°rio", "Cod.Centro Custo", "Dt. Ultima Movimenta√ß√£o", 
            "Cod. Unidade contratante", "Raz√£o Social", "CNPJ", "Turno", "Dt.Emiss√£o.Cart.Prof", 
            "S√©rie CTPS", "CNAE 2.0", "CNAE Livre", "Descri√ß√£o CNAE Livre", "CEI", "Fun√ß√£o", 
            "CNAE 7", "Tipo de CNAE Utilizado", "Descri√ß√£o Detalhada do Cargo", "N¬∫ endere√ßo Unidade", 
            "Complemento endere√ßo Unidade", "Regime de Revezamento", "Org√£o Expedidor do RG", "Campo Livre 1", 
            "Campo Livre 2", "Campo Livre 3", "Telefone SMS", "Grau de Risco", "UF CTPS", "Nome Centro Custo", 
            "Autoriza SMS", "Endere√ßo Cobran√ßa Unidade", "N√∫mero Endere√ßo Cobran√ßa Unidade", 
            "Bairro Cobran√ßa Unidade", "Cidade Cobran√ßa Unidade", "Estado Cobran√ßa Unidade", 
            "Cep Cobran√ßa Unidade", "Complemento Endere√ßo Cobran√ßa Unidade", "Remunera√ß√£o Mensal (R$)", 
            "Telefone Comercial", "Telefone Celular", "Data Emiss√£o RG", "C√≥digo do Pa√≠s de Nascimento", 
            "Origem Descri√ß√£o Detalhada", "Unidade Contratante", "Escolaridade", "C√≥digo Categoria (eSocial)", 
            "Matr√≠cula RH", "G√™nero", "Nome Social", "Tipo de Admiss√£o", "Grau de Instru√ß√£o", 
            "Nome do Pai do Funcion√°rio", "Tipo de V√≠nculo", "Nome do Turno", "Campo Livre 4", 
            "CPF Unidade", "CAEPF Unidade", "Tipo Sangu√≠neo", "Dt. Inicio Periodo Aquisitivo", 
            "Dt. Fim Periodo Aquisitivo", "CNO Unidade", "Desconsiderar para o eSocial", 
            "Dt. Validade RG", "Desconsiderar Unidade para o eSocial"
        ];
        
        const REQUIRED_INDICES = [0, 1, 5, 6, 8, 9, 10, 12, 19, 21, 23, 24, 47];
        const DATE_INDICES = [9, 12, 13, 51, 56, 88, 106, 107, 110];

        const SECTIONS = {
            0: { title: "1. Dados da Unidade e Cargo" },
            8: { title: "2. Identifica√ß√£o e Documentos (Funcion√°rio)" },
            21: { title: "3. Endere√ßo e Contato (Funcion√°rio)" },
            33: { title: "4. Detalhes da Unidade (CNPJ, Endere√ßo)" },
            50: { title: "5. Dados Contratuais, Custos e Profissionais" },
            79: { title: "6. Endere√ßo de Cobran√ßa da Unidade" },
            86: { title: "7. Remunera√ß√£o e Outras Datas" }
        };

        let db = [];

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            toastMsg.textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 flex items-center z-50 ${type === 'success' ? 'bg-emerald-600 text-white' : type === 'error' ? 'bg-red-600 text-white' : 'bg-blue-600 text-white'}`;
            setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 4000);
        }

        function init() { renderForm(); updatePreviewTable(); }

        function renderForm() {
            const container = document.getElementById('dynamicFieldsContainer');
            let currentGrid = null;
            HEADERS_LIST.forEach((header, index) => {
                if (SECTIONS[index]) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = "pt-6 mb-4 col-span-full";
                    sectionDiv.innerHTML = `<h3 class="text-xl font-bold text-slate-800 border-b border-emerald-500 pb-1 mb-4 mt-2">${SECTIONS[index].title}</h3>`;
                    container.appendChild(sectionDiv);
                    currentGrid = document.createElement('div');
                    currentGrid.className = "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6";
                    container.appendChild(currentGrid);
                }
                if (!currentGrid) {
                    currentGrid = document.createElement('div');
                    currentGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                    container.appendChild(currentGrid);
                }
                const wrapper = document.createElement('div');
                const isRequired = REQUIRED_INDICES.includes(index);
                const label = document.createElement('label');
                label.className = "block text-sm font-medium text-slate-700 mb-1";
                label.innerHTML = `${header} ${isRequired ? '<span class="required-marker">*</span>' : ''}`;
                
                let input;
                if (index === 10) { 
                    input = document.createElement('select');
                    input.innerHTML = `<option value="">Selecione</option><option value="M">Masculino</option><option value="F">Feminino</option><option value="O">Outro</option>`;
                } else {
                    input = document.createElement('input');
                    input.type = DATE_INDICES.includes(index) ? 'date' : 'text';
                }
                input.id = `f_${index}`;
                input.className = "w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border p-2.5";
                if (isRequired) input.required = true;
                
                // Defaults
                if (index === 0) input.value = "001";
                if (index === 1) input.value = "Matriz";
                if (index === 18) input.value = "SP";
                if (index === 24) input.value = "SP";
                if (index === 90) input.value = "105";

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                currentGrid.appendChild(wrapper);
            });
        }

        document.getElementById('eSocialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const row = new Array(HEADERS_LIST.length).fill("");
            HEADERS_LIST.forEach((_, i) => {
                const el = document.getElementById(`f_${i}`);
                if (el) row[i] = el.value.trim();
            });
            db.push(row);
            updatePreviewTable();
            toggleExportBtn();
            this.reset();
            // Reset defaults
            document.getElementById('f_0').value = "001";
            document.getElementById('f_1').value = "Matriz";
            document.getElementById('f_18').value = "SP";
            document.getElementById('f_24').value = "SP";
            document.getElementById('f_90').value = "105";
            showToast("Registro adicionado!", "success");
            document.getElementById('formScrollArea').scrollTop = 0;
        });

        function updatePreviewTable() {
            const tbody = document.getElementById('previewBody');
            document.getElementById('countDisplay').innerText = db.length;
            document.getElementById('totalRecordsDisplay').innerText = db.length;
            if (db.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Nenhum registro.</td></tr>`;
                return;
            }
            const recent = db.slice().reverse().slice(0, 5);
            tbody.innerHTML = recent.map((row, idx) => {
                const originalIdx = db.length - 1 - idx;
                return `<tr class="hover:bg-slate-50">
                    <td class="px-6 py-4"><button onclick="removeRecord(${originalIdx})" class="text-red-600 bg-red-50 px-2 py-1 rounded">Excluir</button></td>
                    <td class="px-6 py-4 text-slate-900">${row[6]}</td>
                    <td class="px-6 py-4 font-semibold text-slate-900">${row[8]}</td>
                    <td class="px-6 py-4 text-slate-500">${row[5]}</td>
                    <td class="px-6 py-4 text-slate-500">${row[19]}</td>
                    <td class="px-6 py-4 text-slate-500">${formatDate(row[12])}</td>
                </tr>`;
            }).join('');
        }

        function removeRecord(index) {
            if (confirm("Remover este registro?")) {
                db.splice(index, 1);
                updatePreviewTable();
                toggleExportBtn();
                showToast("Registro removido.", "error");
            }
        }

        function clearAllData() {
            if (confirm("Apagar TUDO?")) {
                db = [];
                updatePreviewTable();
                toggleExportBtn();
                showToast("Dados limpos.", "error");
            }
        }

        function clearForm() {
            if (confirm("Limpar formul√°rio?")) document.getElementById('eSocialForm').reset();
        }

        function formatDate(dateStr) {
            if (!dateStr || !dateStr.includes('-')) return dateStr;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function toggleExportBtn() {
            const btn = document.getElementById('mainExportBtn');
            btn.disabled = db.length === 0;
            btn.classList.toggle('opacity-50', db.length === 0);
            btn.classList.toggle('cursor-not-allowed', db.length === 0);
        }

        function scrollToExport() {
            document.getElementById('exportSection').scrollIntoView({ behavior: 'smooth' });
        }

        // --- NOVA FUN√á√ÉO DE ENVIO ---
        function sendDataToBackend() {
            if (db.length === 0) {
                showToast("Sem dados para exportar.", "error");
                return;
            }

            // Preparar dados (formatar datas para o padr√£o brasileiro para o Excel)
            const formattedDb = db.map(row => {
                return row.map((val, idx) => {
                    if (val && DATE_INDICES.includes(idx)) {
                        return formatDate(val); // converte YYYY-MM-DD para DD/MM/AAAA
                    }
                    return val;
                });
            });

            showToast("Enviando dados para o servidor...", "info");

            fetch("http://localhost:8000/gerar-excel/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ dados: formattedDb })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "ok") {
                    showToast(`Sucesso! Salvo em: ${data.arquivo}`, "success");
                } else {
                    showToast(`Erro: ${data.mensagem}`, "error");
                }
            })
            .catch(error => {
                console.error("Erro:", error);
                showToast("Erro de conex√£o com o backend.", "error");
            });
        }

        init();
    </script>
</body>
</html>